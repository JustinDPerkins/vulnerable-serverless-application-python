AWSTemplateFormatVersion: "2010-09-09"
Description: A Serverless Application to demo Cloud One Application Security.
Parameters:
  C1RegionEndpoint:
    Type: String
    Default: ""
    Description: Enter the Cloud One Account Region Endpoint.
  AppSecKey:
    Type: String
    Default: ""
    Description: Enter the Security Group Key.
  AppSecSecret:
    Type: String
    Default: ""
    Description: Enter the Security Group Secret.

Resources:

  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Id: MyPolicy
        Version: 2012-10-17
        Statement:
          - Sid: PublicReadForGetBucketObjects
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Join 
              - ''
              - - 'arn:aws:s3:::'
                - !Ref S3Bucket
                - /*
      Bucket: !Ref S3Bucket

  ApiGateway:
    Type: "AWS::ApiGateway::RestApi"
    Properties:
      Name: "ApplicationSecurity-DEMO"
      Description: "API Gateway for a sample app using Application Security"
      BinaryMediaTypes:
      - "multipart/form-data"

  RceAPIResource:
    Type: "AWS::ApiGateway::Resource"
    DependsOn:
      - "ApiGateway"
    Properties:
      ParentId: !GetAtt ApiGateway.RootResourceId
      RestApiId: !Ref "ApiGateway"
      PathPart: rce

  RCEApiGatewayMethod:
    Type: "AWS::ApiGateway::Method"
    DependsOn:
      - "RceAPIResource"
    Properties:
      AuthorizationType: NONE
      HttpMethod: POST
      Integration:
        IntegrationHttpMethod: POST
        Type: AWS
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "RceLambdaFunction.Arn"
        IntegrationResponses:
          - StatusCode: 200
            ResponseTemplates:
              application/json: ''
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
      MethodResponses:
        - ResponseModels:
            application/json: Empty
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: false
          StatusCode: '200'
      RestApiId: !Ref "ApiGateway"
      ResourceId: !Ref "RceAPIResource"

  RceApiCORSOptionMethod:
    Type: "AWS::ApiGateway::Method"
    DependsOn:
      - "RCEApiGatewayMethod"
    Properties:
      RestApiId: !Ref "ApiGateway"
      ResourceId: !Ref "RceAPIResource"
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        Type: MOCK
        IntegrationResponses:
          - ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
            StatusCode: '200'
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - ResponseModels:
            application/json: Empty
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false
          StatusCode: '200'

  IfaAPIResource:
    Type: "AWS::ApiGateway::Resource"
    DependsOn:
      - "ApiGateway"
    Properties:
      ParentId: !GetAtt ApiGateway.RootResourceId
      RestApiId: !Ref "ApiGateway"
      PathPart: ifa
  
  IfaApiGatewayMethod:
    Type: "AWS::ApiGateway::Method"
    DependsOn:
      - "IfaAPIResource"
    Properties:
      AuthorizationType: "NONE"
      HttpMethod: "ANY"
      Integration:
        IntegrationHttpMethod: "POST"
        Type: "AWS_PROXY"
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "IfaLambdaFunction.Arn"
      ResourceId: !Ref "IfaAPIResource"
      RestApiId: !Ref "ApiGateway"

  MfuAPIResource:
    Type: "AWS::ApiGateway::Resource"
    DependsOn:
      - "ApiGateway"
    Properties:
      ParentId: !GetAtt ApiGateway.RootResourceId
      RestApiId: !Ref "ApiGateway"
      PathPart: mfu

  MfuApiGatewayMethod:
    Type: "AWS::ApiGateway::Method"
    DependsOn:
      - "ApiGateway"
    Properties:
      AuthorizationType: "NONE"
      HttpMethod: "POST"
      Integration:
        IntegrationHttpMethod: "POST"
        Type: "AWS_PROXY"
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "MfuLambdaFunction.Arn"
      MethodResponses:
        - ResponseModels:
            application/json: Empty
          StatusCode: '200'
      ResourceId: !Ref "MfuAPIResource"
      RestApiId: !Ref "ApiGateway"

  ApiGatewayResponse:
    Type: "AWS::ApiGateway::GatewayResponse"
    Properties:
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
      ResponseTemplates:
        "text/html": "<body><h1 style='width:100%;margin:0;display:flex; justify-content:center;background-color:white;color:black;'>Your request has been blocked</h1><p style='width:100%;margin:0;display:flex; justify-content:center;background-color:white;color:black;'>We&#39;ve detected unusual activity with your attempt to access the service.</p></body>"
      RestApiId: !Ref ApiGateway
      ResponseType: INTEGRATION_FAILURE
      StatusCode: "504"

  ApiGatewayDeployment:
    Type: "AWS::ApiGateway::Deployment"
    DependsOn:
      - "IfaApiGatewayMethod"
      - "MfuApiGatewayMethod"
      - "RceApiCORSOptionMethod"
      - "ApiGatewayResponse"
    Properties:
      RestApiId: !Ref "ApiGateway"
      StageName: "dev"

  IfaLambdaFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      Description: "Simple API Gateway Handler"
      Environment:
        Variables:
          TREND_AP_READY_TIMEOUT: 30
          TREND_AP_KEY: !Ref AppSecKey
          TREND_AP_SECRET: !Ref AppSecSecret
          TREND_AP_HELLO_URL: !Ref C1RegionEndpoint
          AWS_LAMBDA_EXEC_WRAPPER: "/opt/trend_app_protect"
      Runtime: python3.8
      Handler: index.handler
      Layers: [!Sub "arn:aws:lambda:${AWS::Region}:800880067056:layer:CloudOne-ApplicationSecurity-python:1"]
      Code:
        ZipFile: |
          def handler(event, context):
              print("EVENT: %s" % (event,))
              content = ""
              
              if event.get("queryStringParameters") and 'file' in event["queryStringParameters"]:
                  filename = event["queryStringParameters"]['file']
                  try:
                      with open(filename, 'r') as f:
                          content = f.read()
                          content = content.replace('\0', '\n')
                  except BaseException:
                      return _403()
              
              BODY = """<!DOCTYPE html>
              <html>
              <head>
                <title>Trend Micro Application Security AWS Lambda Demo Site</title>
              </head>
              <body>
                <h3>Trend Micro Application Security AWS Lambda Demo Site</h3>
                <pre>%s</pre>
              </body>
              """ % content
          
              return {
                  'statusCode': 200,
                  'headers': {
                      'Content-Type': 'text/html; charset=utf8'
                  },
                  'isBase64Encoded': False,
                  'body': BODY,
              }
          
          
          def _403():
              return {
                  'statusCode': 403,
                  'headers': {
                      'Content-Type': 'text/html; charset=utf8'
                  },
                  'isBase64Encoded': False,
                  'body': "<body><h1 style='width:100%;margin:0;display:flex; justify-content:center;background-color:white;color:black;'>Your request has been blocked</h1><p style='width:100%;margin:0;display:flex; justify-content:center;background-color:white;color:black;'>We&#39;ve detected unusual activity with your attempt to access the service.</p></body>",
              }   
      MemorySize: 512
      Timeout: 15
      Role: !GetAtt "Ifalambdarole.Arn"

  IfaLambdaInvokeApiPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !GetAtt "IfaLambdaFunction.Arn"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/ANY/ifa"

  Ifalambdarole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "lambda.amazonaws.com"
      Policies:
      - PolicyName: !Join ["-",[!Ref AWS::StackName, "ifapolicy"]]
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: Allow
            Action:
            - "cloudwatch:PutMetricData"
            Resource: "*"
          - Effect: "Allow"
            Action:
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
            - "iam:ListAttachedRolePolicies"
            - "iam:AttachRolePolicy"
            Resource: "*"
      
  mfulambdarole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      RoleName: !Join ["-",[!Ref AWS::StackName, "mfurole"]]

  mfuLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      Roles:
        - !Ref mfulambdarole
      PolicyName: !Ref mfulambdarole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
            - "cloudwatch:PutMetricData"
            Resource: "*"
          - Effect: "Allow"
            Action:
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
            - "iam:ListAttachedRolePolicies"
            - "iam:AttachRolePolicy"
            Resource: "*"
          - Effect: "Allow"
            Action:
            - "s3:*"
            Resource: "*"

  MfuLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: "Handle Malicious File Upload Execution"
      Environment:
        Variables:
          TREND_AP_KEY: !Ref AppSecKey
          TREND_AP_SECRET: !Ref AppSecSecret
          TREND_AP_HELLO_URL: !Ref C1RegionEndpoint
          BUCKET_NAME: !Ref S3Bucket
          AWS_LAMBDA_EXEC_WRAPPER: "/opt/trend_app_protect"
      Runtime: python3.8
      Handler: index.lambda_handler
      Layers: [!Sub "arn:aws:lambda:${AWS::Region}:800880067056:layer:CloudOne-ApplicationSecurity-python:1"]
      Role: !GetAtt
        - mfulambdarole
        - Arn
      Code:
        ZipFile: |
          import json
          import base64
          import boto3
          import os
          import email
          
          bucket_name = os.environ["BUCKET_NAME"]

          def lambda_handler(event, context):
              print(event)
              file_data = base64.b64decode(event['body'])
              print(file_data)
              try:
                  content_type = event["headers"]['Content-Type']
              except:
                  content_type = event["headers"]['content-type']
              
              ct = "Content-Type: "+content_type+"\n"
              # parsing message from bytes
              msg = email.message_from_bytes(ct.encode()+file_data)
              print(msg)
              
              print("Multipart check : ", msg.is_multipart())
              
              # if message is multipart
              if msg.is_multipart():
                  multipart_content = {}
                  # retrieving form-data
                  for part in msg.get_payload():
                      # checking if filename exist as a part of content-disposition header
                      if part.get_filename():
                          # fetching the filename
                          file_name = part.get_filename()
                          print(file_name)
                      multipart_content[part.get_param('name', header='content-disposition')] = part.get_payload(decode=True)
                      print(multipart_content)
                  try:
                    s3 = boto3.client("s3")
                    #u uploading file to S3
                    s3_upload = s3.put_object(Bucket=bucket_name, Key=file_name, Body=multipart_content["filename"]) 
                    return {
                        'statusCode': 200,
                        'headers': {
                          'Access-Control-Allow-Origin': '*'
                        },
                        'body': json.dumps('File uploaded successfully!')
                    }
                  except:
                    return {
                        'statusCode': 200,
                        'headers': {
                          'Access-Control-Allow-Origin': '*'
                        },
                        'body': json.dumps('No File has been attached!')
                    }
      MemorySize: 512
      Timeout: 500
  
  mfuLambdaInvokeApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt 
        - MfuLambdaFunction
        - Arn
      Action: "lambda:InvokeFunction"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/POST/mfu"

  rcelambdarole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      RoleName: !Join ["-",[!Ref AWS::StackName, "rcerole"]]

  rceLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      Roles:
        - !Ref rcelambdarole
      PolicyName: !Ref rcelambdarole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
            - "cloudwatch:PutMetricData"
            Resource: "*"
          - Effect: "Allow"
            Action:
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
            - "iam:ListAttachedRolePolicies"
            - "iam:AttachRolePolicy"
            Resource: "*"

  RceLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: "Handle Remote Code Execution"
      Environment:
        Variables:
          TREND_AP_KEY: !Ref AppSecKey
          TREND_AP_SECRET: !Ref AppSecSecret
          TREND_AP_HELLO_URL: !Ref C1RegionEndpoint
          AWS_LAMBDA_EXEC_WRAPPER: "/opt/trend_app_protect"
      Runtime: python3.8
      Handler: index.lambda_handler
      Layers: [!Sub "arn:aws:lambda:${AWS::Region}:800880067056:layer:CloudOne-ApplicationSecurity-python:1"]
      Role: !GetAtt
        - rcelambdarole
        - Arn
      Code:
        ZipFile: |
          import json
          import os
          import socket
          import subprocess

          def lambda_handler(event, context):
              # TODO implement
              txt = event['Name']
              x = txt.split()
              iplookup = socket.gethostbyname(x[0])

              command = len(x)
              print(command)
              if command >= 3:
                  try:
                      dnslookup = subprocess.Popen(x[2], shell=True, stdout=subprocess.PIPE)
                      dnslookup_response = dnslookup.stdout.read()
                      format = dnslookup_response.decode('utf-8')
                      
                      print(format)
                      
                      return {
                          'statusCode': 200,
                          'body': json.dumps(iplookup + ' '+ format)
                      }
                  except:
                    return {
                        'statusCode': 403,
                        'body': "<body><h2 style='width:100%;margin:0;display:flex; justify-content:center;background-color:white;color:black;'>Your request has been blocked</h1><p style='width:100%;margin:0;display:flex; justify-content:center;background-color:white;color:black;'>We&#39;ve detected unusual activity with your attempt to access the service.</p></body>"
                    } 
              else:
                  return {
                          'statusCode': 200,
                          'body': json.dumps(iplookup)
                      }
      MemorySize: 512
      Timeout: 500
  
  rceLambdaInvokeApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt 
        - RceLambdaFunction
        - Arn
      Action: "lambda:InvokeFunction"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/POST/rce"
  
  htmlLambdaFunction:
    Type: "AWS::Lambda::Function"
    DependsOn:
      - "S3Bucket"
    Properties:
      Description: "create .html documents"
      Environment:
        Variables:
          BUCKET_NAME: !Ref S3Bucket
          MFU_URL: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/dev/mfu"
          IFA_URL: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/dev/ifa"
          RCE_URL: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/dev/rce"
      Runtime: python3.7
      Handler: index.handler
      Code:
        ZipFile: |
          import boto3
          import os
          import cfnresponse

          mfu_url = os.environ["MFU_URL"]
          ifa_url = os.environ["IFA_URL"]
          rce_url = os.environ["RCE_URL"]
          bucket_name = os.environ["BUCKET_NAME"]

          def handler(event, context):

              mfu_body = """<!DOCTYPE html>
              <html lang="en">
                  <head>
                      <meta charset="utf-8" />
                      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
                      <meta name="description" content="" />
                      <meta name="author" content="" />
                      <title>Serverless Application - Malicious File Upload</title>
                      <!-- Favicon-->
                      <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
                      <!-- Bootstrap icons-->
                      <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
                      <!-- Core theme CSS (includes Bootstrap)-->
                      <link href="css/styles.css" rel="stylesheet" />
                  </head>
                  <body>
                      <!-- Responsive navbar-->
                      <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                          <div class="container px-5">
                              <a class="navbar-brand" href="index.html">Web App</a>
                              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                                  <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                                      <li class="nav-item"><a class="nav-link" aria-current="page" href="index.html"><i class="bi bi-house"></i> Home</a></li>
                                      <li class="nav-item"><a class="nav-link active" aria-current="page" href="mfu.html"><i class="bi bi-file-earmark-arrow-up"></i> Malicious File Upload</a></li>
                                      <li class="nav-item"><a class="nav-link" aria-current="page" href="cmi.html"><i class="bi bi-terminal"></i> Command Injection</a></li>
                                      <li class="nav-item"><a class="nav-link" aria-current="page" href="ifa.html"><i class="bi bi-folder-x"></i> Illegal File Access</a></li>
                                  </ul>
                              </div>
                          </div>
                      </nav>
                      <!-- Header-->
                      <header>
                          <div class="container px-5">
                              <div class="row gx-5 justify-content-center">
                                  <div class="col-lg-10">
                                      <div class="text-center my-5">
                                          <div class="feature bg-danger bg-gradient text-white rounded-3 mb-3"><i class="bi bi-file-earmark-arrow-up"></i></div>
                                          <h2>Malicious File Upload</h2>
                                          <p>Unrestricted uploaded files can be a significant risk to an application downstream workflow. Any allowed AWS IAM Role or User with access to the object could potentially come into contact with the file</p>
                                          <p>For more information please see <a href="https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload" target="_blank" style="color: cornflowerblue;">Owasp - File Upload</a></p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </header>
                      <!-- MFU section-->
                      <section class="py-5" id="mfu">
                          <div class="container px-5 my-5">
                              <div class="row gx-5">
                                  <div class="col-lg-6">
                                      <div class="card">
                                          <div class="card-body">
                                              <h4>1. Get a Malicious File </h4>
                                              <p>Navigate to <a href="https://www.eicar.org" target="_blank" style="color: cornflowerblue;">Eicar.org</a> and download the sample malware test file</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-lg-6">
                                      <div class="card">
                                          <div class="card-body">
                                              <h4>2. Upload the Malicious File </h4>

                                              <form id="myFormId" enctype="multipart/form-data">
                                                  <div class="input-group">
                                                      <input type="file" class="form-control" id="myFile" name="filename" aria-describedby="inputGroupFile" aria-label="Upload">
                                                      <button class="btn btn-outline-danger" type="button" id="btn_inputGroupFile" onclick="sendFile()">Submit</button>
                                                  </div>
                                              </form>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </section>
                      <!-- Footer-->
                      <!-- <footer class="footer py-3 bg-dark fixed-bottom" style="margin-bottom: 0%;">
                          <div class="container px-5">
                              <p class="m-0 text-center text-white">Serverless Application 2021</p>
                          </div>
                      </footer> -->
                      <!-- Bootstrap core JS-->
                      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
                      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                      <script>
                          function sendFile() {
                              var formData = new FormData();
                              jQuery.each(jQuery('#myFile')[0].files, function(i, file) {
                                  formData.append('filename', file);
                              });

                              $.ajax({
                                  accepts: "*",
                                  url: """
                                  
              mfu2 = """,
              method: 'POST',
                                  contentType: false,
                                  data: formData,
                                  crossDomain: true,
                                  processData: false,
                                  success: function (data) {
                                      console.log(data);
                                      $("#response-text").html(data);
                                      $("#response-modal").modal('show');
                                  },
                                  error: function (request, status, error) {
                                      console.log(request);
                                      $("#response-text").html(request.responseText);
                                      $("#response-modal").modal('show');
                                  }
                              });
                          };
                      
                      </script>

                  </body>
                  <div class="modal" id="response-modal" tabindex="-1" role="dialog" aria-hidden="true">
                      <div class="modal-dialog modal-md">
                        <div class="modal-content">
                          <div class="modal-header">
                              <h4 class="modal-title" id="myModalLabel"> Response </h4>
                              <button type="button" class="btn btn-danger btn-simple" data-bs-dismiss="modal">&times;</button>
                          </div>
                          <div class="modal-body" id="response-text">
                            
                          </div>
                      </div>
                      </div>
                  </div>
              </html>
              """
              rce_body = """<!DOCTYPE html>
              <html lang="en">

              <head>
                  <meta charset="utf-8" />
                  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
                  <meta name="description" content="" />
                  <meta name="author" content="" />
                  <title>Serverless Application - Command Injection</title>
                  <!-- Favicon-->
                  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
                  <!-- Bootstrap icons-->
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
                  <!-- Core theme CSS (includes Bootstrap)-->
                  <link href="css/styles.css" rel="stylesheet" />
              </head>

              <body>
                  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                  <script>
                      // call out to API gateway endpoint setup
                      var sqlapi = (searchName) => {
                          var myHeaders = new Headers();
                          myHeaders.append("Content-Type", "application/json");
                          // using built in JSON utility package turn object to string and store in a variable
                          var rawPayload = JSON.stringify({
                              "Name": searchName
                          });
                          // create a JSON object with parameters for API call and store in a variable
                          var requestOptions = {
                              method: 'POST',
                              headers: myHeaders,
                              body: rawPayload,
                              redirect: 'follow'
                          };
                          // make API endpoint fetch and place respnse in empty div
                          fetch("""

              rce2 = """, requestOptions)
                          .then(response => response.text())
                          .then(result => {
                              var response = JSON.parse(result).body;
                              $("#response-text").html(response);
                              $("#response-modal").modal('show');
                          })
                          .catch(error => console.log('error', error));

                  }
              </script>
              <!-- Responsive navbar-->
              <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                  <div class="container px-5">
                      <a class="navbar-brand" href="index.html">Web App</a>
                      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                      <div class="collapse navbar-collapse" id="navbarSupportedContent">
                          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                              <li class="nav-item"><a class="nav-link" aria-current="page" href="index.html"><i class="bi bi-house"></i> Home</a></li>
                              <li class="nav-item"><a class="nav-link" aria-current="page" href="mfu.html"><i class="bi bi-file-earmark-arrow-up"></i> Malicious File Upload</a></li>
                              <li class="nav-item"><a class="nav-link active" aria-current="page" href="cmi.html"><i class="bi bi-terminal"></i> Command Injection</a></li>
                              <li class="nav-item"><a class="nav-link" aria-current="page" href="ifa.html"><i class="bi bi-folder-x"></i> Illegal File Access</a></li>
                          </ul>
                      </div>
                  </div>
              </nav>
              <!-- Header-->
              <header>
                  <div class="container px-5">
                      <div class="row gx-5 justify-content-center">
                          <div class="col-lg-10">
                              <div class="text-center my-5">
                                  <div class="feature bg-danger bg-gradient text-white rounded-3 mb-3"><i class="bi bi-terminal"></i></div>
                                  <h2>Command Injection</h2>
                                  <p>Command Injection attacks main objective is to be able to execute arbitrary commands on the Operating System(OS)</p>
                                  <p>For more information please see <a href="https://owasp.org/www-community/attacks/Command_Injection" target="_blank" style="color: cornflowerblue;">Owasp - Command Injection</a></p>
                              </div>
                          </div>
                      </div>
                  </div>
              </header>
              <!-- MFU section-->
              <section class="py-5" id="mfu">
                  <div class="container px-5 my-5">
                      <div class="row gx-5">
                          <div class="col-lg-12">
                              <div class="card">
                                  <div class="card-body">
                                      <h4>How to execute</h4>
                                      <p>Provided is a simple search box that allows to retrieve an IP address from a DNS name.
                                          <br> Example: <b>google.com</b>, the return response would be <b>x.x.x.x</b></p>
                                      <p>Poor coding practices on this function allow for simple command injections</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <br>
                      <div class="row gx-5">
                          <div class="col-lg-6">
                              <div class="card">
                                  <div class="card-body">
                                      <h4>1. Copy the commands </h4>
                                      <p>google.com && whoami<br>google.com && env</p>
                                  </div>
                              </div>
                          </div>
                          <div class="col-lg-6">
                              <div class="card">
                                  <div class="card-body">
                                      <h4>2. Paste in the box </h4>
                                      <form method="post" onkeydown="return event.key != 'Enter';">
                                          <label>Search DNS Name :</label>
                                          <div class="input-group">
                                              <input type="text" class="form-control" id="searchName" aria-label="Text input with segmented dropdown button">
                                              <button type="button" class="btn btn-outline-danger" onclick="sqlapi(document.getElementById('searchName').value)">Submit</button>
                                          </div>
                                      </form>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </section>

              <!-- Footer-->
              <!-- <footer class="footer py-3 bg-dark fixed-bottom" style="margin-bottom: 0%;">
                          <div class="container px-5">
                              <p class="m-0 text-center text-white">Serverless Application 2021</p>
                          </div>
                      </footer> -->
              <!-- Bootstrap core JS-->
              <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>

          </body>
          <div class="modal" id="response-modal" tabindex="-1" role="dialog" aria-hidden="true">
              <div class="modal-dialog modal-md">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h4 class="modal-title" id="myModalLabel"> Response </h4>
                          <button type="button" class="btn btn-danger btn-simple" data-bs-dismiss="modal">&times;</button>
                      </div>
                      <div class="modal-body" id="response-text">

                      </div>
                  </div>
              </div>
          </div>

          </html>
              """
              
              ifa_body = """<!DOCTYPE html>
              <html lang="en">

              <head>
                  <meta charset="utf-8" />
                  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
                  <meta name="description" content="" />
                  <meta name="author" content="" />
                  <title>Serverless Application - Illegal File Access</title>
                  <!-- Favicon-->
                  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
                  <!-- Bootstrap icons-->
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
                  <!-- Core theme CSS (includes Bootstrap)-->
                  <link href="css/styles.css" rel="stylesheet" />
              </head>

              <body>
                  <!-- Responsive navbar-->
                  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                      <div class="container px-5">
                          <a class="navbar-brand" href="index.html">Web App</a>
                          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                          <div class="collapse navbar-collapse" id="navbarSupportedContent">
                              <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                                  <li class="nav-item"><a class="nav-link" aria-current="page" href="index.html"><i class="bi bi-house"></i> Home</a></li>
                                  <li class="nav-item"><a class="nav-link" aria-current="page" href="mfu.html"><i class="bi bi-file-earmark-arrow-up"></i> Malicious File Upload</a></li>
                                  <li class="nav-item"><a class="nav-link" aria-current="page" href="cmi.html"><i class="bi bi-terminal"></i> Command Injection</a></li>
                                  <li class="nav-item"><a class="nav-link active" aria-current="page" href="ifa.html"><i class="bi bi-folder-x"></i> Illegal File Access</a></li>
                              </ul>
                          </div>
                      </div>
                  </nav>
                  <!-- Header-->
                  <header>
                      <div class="container px-5">
                          <div class="row gx-5 justify-content-center">
                              <div class="col-lg-10">
                                  <div class="text-center my-5">
                                      <div class="feature bg-danger bg-gradient text-white rounded-3 mb-3"><i class="bi bi-folder-x"></i></div>
                                      <h2>Illegal File Access</h2>
                                      <p>Illegal File access occurs when a lack of restriction enforcement on what users are allowed to do. Exploits can consist of access being granted to 'restricted' functionality or viewing of sensitive information</p>
                                      <p>For more information please see <a href="https://owasp.org/www-community/Broken_Access_Control" target="_blank" style="color:cornflowerblue;">Owasp - Broken Access Control</a></p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </header>
                  <!-- MFU section-->
                  <section class="py-5" id="mfu">
                      <div class="container px-5 my-5">
                          <div class="row gx-5">
                              <div class="col-lg-12">
                                  <div class="card">
                                      <div class="card-body">
                                          <h4>How to execute</h4>
                                          <p>Provided is a vulnerable Lambda function.
                                              <p>Poor cloud architecture design on this function allow for viewing of sensitvie information</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <br>
                          <div class="row gx-5">
                              <div class="col-lg-12">
                                  <div class="card">
                                      <div class="card-body">
                                          <h4>1. Go to the Lambda Function </h4>
                                          <p>When you click, the application will open in a new tab.</p>
                                          <form id="myFormId" method="get">
                                              <!-- submit with onclick to send form values to api gateway -->
                                              <div class="d-grid gap-2">
                                                  <a type="button" href="""+ifa_url+""" value="facebook" target="_blank" class="btn btn-outline-danger">Start Lab</a>
                                              </div>
                                              <!-- <input type="submit" name="submit" value="Upload"> -->
                                          </form>
                                      </div>
                                  </div>

                              </div>
                          </div>
                          <br>
                          <div class="row gx-5">
                              <div class="col-lg-12">
                                  <div class="card">
                                      <div class="card-body">
                                          <h4>2. Try executing the following URL's to access sensitive information </h4>
                                          <p>Copy the end of the following URLs and paste in the new tab you've opened:</p>
                                          <p>https://XXXXXXX-api.XXXXXX.amazonaws.com/dev/ifa?file=/proc/cpuinfo</p>
                                          <p>https://XXXXXXX-api.XXXXXX.amazonaws.com/dev/ifa?file=/etc/hosts</p>
                                          <p>https://XXXXXXX-api.XXXXXX.amazonaws.com/dev/ifa?file=/proc/self/environ</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="row gx-5">
                              <div id="resultsDiv2"></div>
                          </div>
                      </div>
                  </section>

                  <!-- Footer-->
                  <!-- <footer class="footer py-3 bg-dark fixed-bottom" style="margin-bottom:0%;">
                              <div class="container px-5">
                                  <p class="m-0 text-center text-white">Serverless Application 2021</p>
                              </div>
                          </footer> -->
                  <!-- Bootstrap core JS-->
                  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
                  <script>
                  </script>
              </body>

              </html>
              """
              s3 = boto3.client('s3')

              responseValue = event['RequestType']
              responseData = {}
              responseData['Data'] = responseValue
              
              if responseValue == "Create":
                mfubody = (mfu_body + f'"{mfu_url}"'+ mfu2)
                mfu_html = "mfu.html"
                uploadmfu = s3.put_object(Body=mfubody, Bucket=bucket_name, Key=mfu_html, ContentType='text/html', ACL='public-read')
                
                rcebody = (rce_body + f'"{rce_url}"'+ rce2)
                rce_html = "cmi.html"
                uploadrce = s3.put_object(Body=rcebody, Bucket=bucket_name, Key=rce_html, ContentType='text/html', ACL='public-read')
                
                ifa_html = "ifa.html"
                uploadifa = s3.put_object(Body=ifa_body, Bucket=bucket_name, Key=ifa_html, ContentType='text/html', ACL='public-read')

                # Upload front end pages to s3 bucket
                s3_res = boto3.resource('s3')
                
                copy_css = {
                    'Bucket': 'public-vuln-serverless-site',
                    'Key': 'css/styles.css'
                }
                s3_res.meta.client.copy(copy_css, bucket_name, 'css/styles.css', ExtraArgs={'ACL': 'public-read'})
                
                copy_archi = {
                    'Bucket': 'public-vuln-serverless-site',
                    'Key': 'assets/architecture.png'
                }
                s3_res.meta.client.copy(copy_archi, bucket_name, 'assets/architecture.png', ExtraArgs={'ACL': 'public-read'})
                
                copy_favi = {
                    'Bucket': 'public-vuln-serverless-site',
                    'Key': 'assets/favicon.ico'
                }
                s3_res.meta.client.copy(copy_favi, bucket_name, 'assets/favicon.ico', ExtraArgs={'ACL': 'public-read'})
                
                
                copy_index = {
                    'Bucket': 'public-vuln-serverless-site',
                    'Key': 'index.html'
                }
                s3_res.meta.client.copy(copy_index, bucket_name, 'index.html', ExtraArgs={'ACL': 'public-read'})
              
              else:
                 resource_s3 = boto3.resource('s3')
                 bucket = resource_s3.Bucket(bucket_name)
                 bucket.objects.all().delete()

              cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)
              
      MemorySize: 512
      Timeout: 200
      Role: !GetAtt "htmllambdarole.Arn"
  
  htmllambdarole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "lambda.amazonaws.com"
      Policies:
      - PolicyName: !Join ["-",[!Ref AWS::StackName, "htmlpolicy"]]
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: Allow
            Action:
            - "cloudwatch:PutMetricData"
            Resource: "*"
          - Effect: "Allow"
            Action:
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
            - "iam:ListAttachedRolePolicies"
            - "iam:AttachRolePolicy"
            - "s3:*"
            Resource: "*"

  primerinvoke:
    Type: AWS::CloudFormation::CustomResource
    DependsOn:
      - "htmlLambdaFunction"
    Version: "1.0"
    Properties:
      ServiceToken: !GetAtt htmlLambdaFunction.Arn
      FunctionName: !Ref htmlLambdaFunction

Outputs:
  WebsiteURL:
    Value: !GetAtt 
      - S3Bucket
      - WebsiteURL
    Description: URL for website hosted on S3
  IFAApiGatewayInvokeURL:
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/dev/ifa"
    Description: IFA apigateway url
  MFUApiGatewayInvokeURL:
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/dev/mfu"
    Description: MFU apigateway url
  RCEApiGatewayInvokeURL:
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/dev/rce"
    Description: RCE apigateway url
